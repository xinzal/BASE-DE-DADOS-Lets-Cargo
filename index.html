<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LetsCargo - Visualizar Pedidos</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f2f4f8; padding: 20px; }
  h1 { color: #003c8f; margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; background-color: #fff; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #0073c9; color: white; }
  button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
  .btn-acao { background-color: #0073c9; color: white; }
  .btn-acao:hover { background-color: #005fa3; }
  .modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    width: 300px;
    border-radius: 8px;
  }
  .modal-content h2 { margin-top: 0; }
  .modal-content input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    box-sizing: border-box;
  }
  .close-btn {
    background-color: red;
    color: white;
    float: right;
  }
</style>
</head>
<body>

<h1>Visualizar Pedidos - LetsCargo</h1>

<!-- FILTRO E PESQUISA -->
<div style="margin-bottom: 10px;">
  <label for="filtroFabrica">Filtrar por Fábrica:</label>
  <select id="filtroFabrica" onchange="filtrarTabela()">
    <option value="">Todas</option>
  </select>

  <label for="pesquisaPedido" style="margin-left: 20px;">Pesquisar Número do Pedido:</label>
  <input type="text" id="pesquisaPedido" oninput="filtrarTabela()" placeholder="Digite o número do pedido">
</div>

<table id="pedidosTable">
  <thead>
    <tr>
      <th>Número do Pedido</th>
      <th>Fábrica</th>
      <th>Código do Item</th>
      <th>Descrição</th>
      <th>Quantidade</th>
      <th>Data do Pedido</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="pedidosBody">
    <tr><td colspan="7">Carregando pedidos...</td></tr>
  </tbody>
</table>

<!-- Modal de Cadastro -->
<div id="modalCadastro" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharModal()">X</button>
    <h2>Cadastrar Dados</h2>
    <input type="number" id="pallets" placeholder="Pallets">
    <input type="number" id="peso" placeholder="Peso Separação (kg)">
    <input type="number" id="estoque" placeholder="Quantidade em Estoque">
    <button class="btn-acao" onclick="enviarDados()">Enviar</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyzRQQNQcTmcgkihOKmFj_MKRpzZBmjdlQGyaNj1BZ59IV89UWI0RzP3o7VRHsWrGTmTA/exec";
let pedidoSelecionado = null;

// ======== CARREGAR PEDIDOS ========
async function carregarPedidos() {
  const tbody = document.getElementById("pedidosBody");
  tbody.innerHTML = `<tr><td colspan="7">Carregando...</td></tr>`;

  try {
    const res = await fetch(WEB_APP_URL + "?action=get");
    const pedidos = await res.json();

    if (pedidos.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7">Nenhum pedido encontrado</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    pedidos.forEach((p, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.numero}</td>
        <td>${p.fabrica}</td>
        <td>${p.codigo}</td>
        <td>${p.descricao}</td>
        <td>${p.quantidade}</td>
        <td>${p.dataPedido}</td>
        <td><button class="btn-acao" onclick="abrirModal(${i})">Cadastrar Dados</button></td>
      `;
      tr.dataset.index = i;
      tr.dataset.numero = p.numero;
      tr.dataset.fabrica = p.fabrica;
      tr.dataset.codigo = p.codigo;
      tr.dataset.descricao = p.descricao;
      tr.dataset.quantidade = p.quantidade;

      // linha verde se já houver cadastro
      if (p.pallets || p.peso || p.estoque) {
        tr.style.backgroundColor = "#c8f7c5";
      }

      tbody.appendChild(tr);
    });

    // popular filtro de fábrica
    atualizarFiltroFabrica(pedidos);

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="7">Erro ao carregar pedidos</td></tr>`;
  }
}

// ======== FILTRO E PESQUISA ========
function atualizarFiltroFabrica(pedidos) {
  const select = document.getElementById("filtroFabrica");
  const fabricas = [...new Set(pedidos.map(p => p.fabrica))];
  fabricas.forEach(f => {
    const option = document.createElement("option");
    option.value = f;
    option.textContent = f;
    select.appendChild(option);
  });
}

function filtrarTabela() {
  const filtroFabrica = document.getElementById("filtroFabrica").value.toLowerCase();
  const pesquisaPedido = document.getElementById("pesquisaPedido").value.toLowerCase();
  const linhas = document.querySelectorAll("#pedidosBody tr");

  linhas.forEach(tr => {
    const numero = tr.dataset.numero.toLowerCase();
    const fabrica = tr.dataset.fabrica.toLowerCase();

    const mostrar =
      (filtroFabrica === "" || fabrica === filtroFabrica) &&
      (pesquisaPedido === "" || numero.includes(pesquisaPedido));

    tr.style.display = mostrar ? "" : "none";
  });
}

// ======== ABRIR / FECHAR MODAL ========
function abrirModal(index) {
  const row = document.querySelector(`tr[data-index='${index}']`);
  pedidoSelecionado = {
    numero: row.dataset.numero,
    fabrica: row.dataset.fabrica,
    codigo: row.dataset.codigo,
    descricao: row.dataset.descricao,
    quantidade: row.dataset.quantidade
  };
  document.getElementById("modalCadastro").style.display = "block";
}

function fecharModal() {
  document.getElementById("modalCadastro").style.display = "none";
  pedidoSelecionado = null;
  document.getElementById("pallets").value = "";
  document.getElementById("peso").value = "";
  document.getElementById("estoque").value = "";
}

// ======== ENVIAR DADOS PARA PLANILHA ========
async function enviarDados() {
  if (!pedidoSelecionado) return;

  const pallets = document.getElementById("pallets").value.trim();
  const peso = document.getElementById("peso").value.trim();
  const estoque = document.getElementById("estoque").value.trim();

  if (!pallets || !peso || !estoque) {
    alert("Preencha todos os campos antes de enviar.");
    return;
  }

  const dados = {
    numero: pedidoSelecionado.numero,
    fabrica: pedidoSelecionado.fabrica,
    itens: [{
      codigo: pedidoSelecionado.codigo,
      descricao: pedidoSelecionado.descricao,
      quantidade: pedidoSelecionado.quantidade,
      pallets,
      peso,
      estoque
    }]
  };

  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify(dados)
    });
    const result = await response.json();
    if (result.status === "success") {
      alert("Dados enviados com sucesso!");

      // linha verde
      const linhas = document.querySelectorAll("#pedidosBody tr");
      linhas.forEach(tr => {
        if (tr.dataset.numero === pedidoSelecionado.numero && tr.dataset.codigo === pedidoSelecionado.codigo) {
          tr.style.backgroundColor = "#c8f7c5";
        }
      });

      fecharModal();
    } else {
      alert("Erro ao salvar: " + result.message);
    }
  } catch (err) {
    alert("Erro de conexão com o servidor.");
  }
}

// ======== INÍCIO ========
carregarPedidos();
</script>

</body>
</html>
