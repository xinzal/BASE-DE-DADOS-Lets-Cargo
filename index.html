<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lets Cargo - Visualizar Pedidos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f6f8;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #003c8f;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    margin-top: 20px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
  }
  th {
    background-color: #003c8f;
    color: white;
  }
  tr:hover {
    background-color: #f1f1f1;
  }
  button {
    background-color: #003c8f;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0051c7;
  }
  #menuCadastro {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 999;
  }
  #menuCadastro input {
    width: 100%;
    padding: 8px;
    margin: 8px 0;
    box-sizing: border-box;
  }
  #overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 998;
  }
  .linha-verde {
    background-color: #c8e6c9 !important;
    transition: background-color 0.5s ease;
  }
</style>
</head>
<body>

<h1>ðŸ“¦ Lets Cargo - Visualizar Pedidos</h1>

<table id="tabelaPedidos">
  <thead>
    <tr>
      <th>NÃºmero do Pedido</th>
      <th>FÃ¡brica</th>
      <th>CÃ³digo</th>
      <th>DescriÃ§Ã£o</th>
      <th>Quantidade</th>
      <th>Data do Pedido</th>
      <th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody id="corpoTabela">
    <tr><td colspan="7">Carregando...</td></tr>
  </tbody>
</table>

<div id="overlay"></div>

<div id="menuCadastro">
  <h3>Atualizar Pedido</h3>
  <label>Pallets:</label>
  <input type="number" id="palletsInput" placeholder="Quantidade de pallets">
  <label>Peso SeparaÃ§Ã£o:</label>
  <input type="number" id="pesoInput" placeholder="Peso total (kg)">
  <label>Quantidade em Estoque:</label>
  <input type="number" id="estoqueInput" placeholder="Quantidade disponÃ­vel">

  <div style="text-align:right; margin-top:15px;">
    <button onclick="enviarDados()">Enviar</button>
    <button onclick="fecharMenu()">Cancelar</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzJOmABpg-yBT3pTYvTY4K9HdHiA2g7yyVC5FbvopPjgUfdudUkpCmzmhybL7MeomjrqQ/exec";

let linhaSelecionada = null;

// === Carrega pedidos ===
async function carregarPedidos() {
  try {
    const res = await fetch(WEB_APP_URL + "?action=get");
    const pedidos = await res.json();
    const tbody = document.getElementById("corpoTabela");
    tbody.innerHTML = "";

    pedidos.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.numero}</td>
        <td>${p.fabrica}</td>
        <td>${p.codigo}</td>
        <td>${p.descricao}</td>
        <td>${p.quantidade}</td>
        <td>${p.dataPedido}</td>
        <td><button onclick="abrirMenu(this)">Cadastrar</button></td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    document.getElementById("corpoTabela").innerHTML = `<tr><td colspan="7">Erro ao carregar pedidos</td></tr>`;
  }
}

// === Abre o menu de cadastro ===
function abrirMenu(botao) {
  linhaSelecionada = botao.closest("tr");
  document.getElementById("menuCadastro").style.display = "block";
  document.getElementById("overlay").style.display = "block";
}

// === Fecha o menu ===
function fecharMenu() {
  document.getElementById("menuCadastro").style.display = "none";
  document.getElementById("overlay").style.display = "none";
  document.getElementById("palletsInput").value = "";
  document.getElementById("pesoInput").value = "";
  document.getElementById("estoqueInput").value = "";
}

// === Envia os dados preenchidos ===
async function enviarDados() {
  if (!linhaSelecionada) return;

  const numero = linhaSelecionada.cells[0].innerText;
  const fabrica = linhaSelecionada.cells[1].innerText;
  const codigo = linhaSelecionada.cells[2].innerText;
  const descricao = linhaSelecionada.cells[3].innerText;
  const quantidade = linhaSelecionada.cells[4].innerText;

  const pallets = document.getElementById("palletsInput").value;
  const peso = document.getElementById("pesoInput").value;
  const estoque = document.getElementById("estoqueInput").value;

  const dados = {
    numero,
    fabrica,
    itens: [{ codigo, descricao, quantidade, pallets, peso, estoque }]
  };

  try {
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify(dados),
      headers: { "Content-Type": "application/json" }
    });

    const result = await response.json();

    if (result.status === "success") {
      linhaSelecionada.classList.add("linha-verde"); // marca de verde âœ…
      fecharMenu();
    } else {
      alert("Erro: " + result.message);
    }
  } catch (err) {
    alert("Erro ao enviar dados: " + err.message);
  }
}

carregarPedidos();
</script>

</body>
</html>
